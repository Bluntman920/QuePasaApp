<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Que Pasa App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: sans-serif;
      margin: 0; padding: 0;
      background: #f3f3f3 url('QuePasaLogo.png') repeat;
      background-size: 320px 320px;
    }
    .support-link {
      display: block;
      width: 100%;
      text-align: center;
      font-size: 1.6em;
      color: #2ecc71;
      text-decoration: none;
      font-weight: 700;
      background: #fff;
      padding: 22px 0 13px 0;
      margin-bottom: 6px;
      border-bottom: 2px solid #e0e0e0;
      letter-spacing: 0.5px;
    }
    .support-link:hover {
      text-decoration: underline;
      color: #198f4d;
    }
    .center-box {
      max-width: 1700px;
      margin: 40px auto 0 auto;
      background: #fff;
      border-radius: 48px;
      box-shadow: 0 12px 48px #0001;
      padding: 40px 36px 45px 36px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .big-x {
      position: absolute;
      right: 40px;
      top: 40px;
      width: 90px;
      height: 90px;
      background: #e74c3c;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      box-shadow: 0 4px 24px #0004;
      transition: background 0.2s;
      border: 4px solid #fff;
    }
    .big-x:hover {
      background: #c0392b;
    }
    .big-x svg {
      width: 55px;
      height: 55px;
      display: block;
    }
    .top-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 60px;
      margin-bottom: 36px;
      width: 100%;
    }
    .logo-img, .qr-img {
      width: 400px;
      height: 400px;
      object-fit: contain;
      border-radius: 36px;
      background: #f8f8f8;
      border: 3px solid #eee;
      box-shadow: 0 3px 32px #2221;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }
    .room-title {
      margin-bottom: 20px;
      font-size: 2.1em;
      font-weight: 700;
      color: #111;
      text-align: center;
      width: 100%;
    }
    .room-id {
      color: #2ecc71;
      font-family: monospace;
      font-size: 1.2em;
      margin-left: 10px;
      word-break: break-all;
    }
    .new-room-btn {
      margin-left: 20px;
      font-size: 1.1em;
      background: #2ecc71;
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 9px 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .new-room-btn:hover {
      background: #1e9f4d;
    }
    .msg-area {
      width: 100%;
      min-height: 300px;
      background: #fafafa;
      border: 2px solid #eee;
      border-radius: 18px;
      margin-bottom: 18px;
      padding: 20px 15px 7px 15px;
      overflow-y: auto;
      font-size: 1.6em;
      max-height: 500px;
    }
    .alone-message {
      color: #e74c3c;
      background: #fff4f4;
      border: 2px solid #e74c3c;
      border-radius: 10px;
      text-align: center;
      font-size: 1.25em;
      margin: 14px auto 8px auto;
      padding: 18px 10px;
      max-width: 520px;
      font-weight: bold;
      letter-spacing: 0.5px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }
    .alone-message .new-room-btn {
      margin-left: 0;
      margin-top: 12px;
      font-size: 1.1em;
      padding: 7px 30px;
      background: #2ecc71;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      display: inline-block;
    }
    .alone-message .new-room-btn:hover {
      background: #1e9f4d;
    }
    .msg {
      margin-bottom: 18px;
      word-break: break-word;
    }
    .sender {
      font-weight: bold;
      color: #2ecc71;
    }
    .msg.mine .sender {
      color: #111;
    }
    .input-row {
      display: flex;
      width: 100%;
      gap: 12px;
      margin-bottom: 10px;
    }
    #msgInput {
      flex: 1;
      font-size: 1.2em;
      padding: 13px;
      border-radius: 10px;
      border: 2px solid #ddd;
      outline: none;
      background: #f7f7f7;
    }
    #sendBtn {
      font-size: 1.1em;
      padding: 12px 30px;
      border-radius: 10px;
      border: none;
      background: #2ecc71;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
    }
    #sendBtn:hover { background: #1e9f4d; }
    .bottom-link {
      display: block;
      width: 100%;
      text-align: center;
      font-size: 1.3em;
      color: #16a085;
      text-decoration: underline;
      margin-top: 20px;
      font-weight: 600;
      letter-spacing: 0.5px;
      background: transparent;
      border: none;
      cursor: pointer;
      margin-bottom: -10px;
    }
    @media (max-width: 900px) {
      .center-box {
        max-width: 98vw;
        padding: 3vw 2vw 3vw 2vw;
        border-radius: 18px;
      }
      .big-x { width: 60px; height: 60px; right: 10px; top: 10px;}
      .big-x svg { width: 34px; height: 34px;}
      .top-row {
        flex-direction: column;
        gap: 22px;
        width: 100%;
      }
      .logo-img, .qr-img {
        width: 70vw;
        height: 70vw;
        min-width: 120px;
        min-height: 120px;
        max-width: 96vw;
        max-height: 96vw;
      }
      .room-title { font-size: 1.14em; }
      .room-id { font-size: 1em; }
      .msg-area { font-size: 1.06em; min-height: 130px; max-height: 230px; }
      #msgInput { font-size: 1.1em; padding: 4vw; }
      #sendBtn { font-size: 1.1em; padding: 2vw 6vw; }
      .new-room-btn { font-size: 0.97em; padding: 7px 16px; }
      .bottom-link { font-size: 1.1em; }
      .alone-message { font-size: 1em; padding: 10px 4px; }
    }
    @media (max-width: 500px) {
      .center-box { padding: 6vw 1vw 4vw 1vw; }
      .logo-img, .qr-img {
        width: 92vw;
        height: 92vw;
        min-width: 70px;
        min-height: 70px;
        max-width: 98vw;
        max-height: 98vw;
      }
      .msg-area { padding: 10px 4px 6px 6px; }
    }
  </style>
</head>
<body>
  <a class="support-link" href="https://cash.app/$QuePasaApp" target="_blank" rel="noopener">$QuePasaApp</a>
  <div class="center-box">
    <div class="big-x" id="leaveBtn" title="Leave Chat">
      <svg viewBox="0 0 100 100">
        <circle cx="50" cy="50" r="48" fill="none"/>
        <line x1="28" y1="28" x2="72" y2="72" stroke="#fff" stroke-width="12" stroke-linecap="round"/>
        <line x1="72" y1="28" x2="28" y2="72" stroke="#fff" stroke-width="12" stroke-linecap="round"/>
      </svg>
    </div>
    <div class="top-row">
      <img class="logo-img" src="QuePasaLogo.png" alt="Que Pasa Logo" />
      <div class="qr-img" id="qr"></div>
    </div>
    <div class="room-title">
      Room: <span id="roomId" class="room-id"></span>
      <button class="new-room-btn" id="newRoomBtn">New Room</button>
    </div>
    <div class="msg-area" id="messages"></div>
    <div id="aloneContainer"></div>
    <div class="input-row">
      <input type="text" id="msgInput" placeholder="Type message..." autocomplete="off">
      <button id="sendBtn">Send</button>
    </div>
    <a class="bottom-link" href="https://cash.app/$QuePasaApp" target="_blank" rel="noopener">$QuePasaApp</a>
  </div>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- QR Code JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyDj9I6Rt64jHqA0AhhVQtHDshz5v03s3x8",
      authDomain: "quepasaapp-8c246.firebaseapp.com",
      projectId: "quepasaapp-8c246",
      storageBucket: "quepasaapp-8c246.appspot.com",
      messagingSenderId: "578912881169",
      appId: "1:578912881169:web:a076538a2f57e069ced55c"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    // --- User presence logic ---
    let room, myId, myName, msgListenerRef, presenceRef, presenceListener;
    function randomRoom() {
      let arr = new Uint32Array(4);
      window.crypto.getRandomValues(arr);
      return Array.from(arr).map(x => x.toString(36)).join('').toUpperCase();
    }
    function getRoomFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('room');
    }
    function setRoomInUrl(room) {
      window.history.replaceState({}, '', '?room=' + room);
    }
    function assignName(room) {
      const colors = [
        "White", "Black", "Green", "Red", "Blue", "Orange", "Purple", "Yellow", "Pink", "Brown",
        "Cyan", "Magenta", "Teal", "Indigo", "Lime", "Violet"
      ];
      const key = 'colorName_' + room;
      if (sessionStorage.getItem(key)) return sessionStorage.getItem(key);
      const color = colors[Math.floor(Math.random() * colors.length)];
      const name = `Mister ${color}`;
      sessionStorage.setItem(key, name);
      return name;
    }
    const colorStyles = {
      White: "#eaeaea", Black: "#222", Green: "#2ecc71", Red: "#e74c3c", Blue: "#3498db",
      Orange: "#e67e22", Purple: "#9b59b6", Yellow: "#f1c40f", Pink: "#ff69b4", Brown: "#a0522d",
      Cyan: "#1abc9c", Magenta: "#e040fb", Teal: "#008080", Indigo: "#3f51b5", Lime: "#cddc39", Violet: "#8e24aa"
    };

    function setupRoom(newRoom) {
      // --- CLEANUP old listeners ---
      if (msgListenerRef) msgListenerRef.off();
      if (presenceRef) {
        if (presenceListener) presenceRef.off('value', presenceListener);
        if (myId) presenceRef.child(myId).remove();
      }
      sessionStorage.removeItem('colorName_' + (room || ''));
      // --- SETUP new room ---
      room = newRoom;
      setRoomInUrl(room);
      document.getElementById('roomId').textContent = room;
      document.getElementById('messages').innerHTML = "";
      document.getElementById('aloneContainer').innerHTML = "";
      renderQR();
      myName = assignName(room);
      myId = (Math.random().toString(36)+Date.now().toString(36));
      // User presence
      presenceRef = db.ref('chatrooms/' + room + '/presence');
      presenceRef.child(myId).set({name: myName, ts: firebase.database.ServerValue.TIMESTAMP});
      presenceRef.child(myId).onDisconnect().remove(); // Remove self on disconnect
      // Listen for presence changes
      presenceListener = function(snapshot) {
        const presence = snapshot.val() || {};
        const others = Object.keys(presence).filter(k => k !== myId);
        showAloneUI(others.length === 0);
      };
      presenceRef.on('value', presenceListener);
      // Listen for messages
      msgListenerRef = db.ref('chatrooms/' + room + '/messages');
      msgListenerRef.on('child_added', snap => {
        const msg = snap.val();
        addMsg(msg.text, msg.sender);
      });
    }

    function renderQR() {
      let joinUrl = window.location.origin + window.location.pathname + '?room=' + room;
      document.getElementById('qr').innerHTML = "";
      let qrSize = 400;
      if (window.innerWidth < 600) qrSize = Math.floor(window.innerWidth * 0.72);
      new QRCode(document.getElementById('qr'), {
        text: joinUrl,
        width: qrSize,
        height: qrSize
      });
    }
    window.addEventListener('resize', renderQR);

    const messagesDiv = document.getElementById('messages');
    function addMsg(text, sender) {
      const div = document.createElement('div');
      div.className = 'msg' + (sender === myName ? ' mine' : '');
      let color = null;
      if (sender && sender.startsWith("Mister ")) {
        color = sender.replace("Mister ", "").trim();
      }
      div.innerHTML = `<span class="sender" style="color:${colorStyles[color] || '#2ecc71'}">${sender}:</span> ${text}`;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Show/hide "You're alone" UI
    function showAloneUI(isAlone) {
      const container = document.getElementById('aloneContainer');
      container.innerHTML = "";
      if (isAlone) {
        const aloneDiv = document.createElement('div');
        aloneDiv.className = 'alone-message';
        aloneDiv.innerHTML = `You're alone. Create new room.<br>`;
        const btn = document.createElement('button');
        btn.className = 'new-room-btn';
        btn.innerText = 'Create New Room';
        btn.onclick = function() {
          setupRoom(randomRoom());
        };
        aloneDiv.appendChild(btn);
        container.appendChild(aloneDiv);
      }
    }

    // --- Initial room setup ---
    setupRoom(getRoomFromUrl() || randomRoom());

    // Send message
    const msgInput = document.getElementById('msgInput');
    function sendMsg() {
      const text = msgInput.value.trim();
      if (!text) return;
      db.ref('chatrooms/' + room + '/messages').push({
        text: text,
        sender: myName
      });
      msgInput.value = '';
    }
    document.getElementById('sendBtn').onclick = sendMsg;
    msgInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') sendMsg();
    });

    // New room button
    document.getElementById('newRoomBtn').onclick = function() {
      setupRoom(randomRoom());
    };

    // Leave (big red X) button logic
    document.getElementById('leaveBtn').onclick = function() {
      setupRoom(randomRoom());
    };
  </script>
</body>
</html>
