<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secure Chat Room</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      height: 100%; min-height: 100%;
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f3f3f3;
      box-sizing: border-box;
    }
    body {
      min-height: 100vh;
      background: #f3f3f3 url('YOUR_LOGO.png') repeat center center;
      background-size: 160px 160px;
    }
    #main {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
    }
    #topInfo {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding-bottom: 120px;
    }
    #qrRow {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 38px;
      margin-bottom: 20px;
    }
    #qr {
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 4px 36px #0002;
      padding: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 220px;
      min-height: 220px;
      cursor: pointer;
      transition: box-shadow 0.18s;
    }
    #qr:hover {
      box-shadow: 0 8px 50px #2ecc7133;
    }
    #tipBox {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      background: rgba(255,255,255,0.92);
      border-radius: 18px;
      padding: 18px 20px;
      font-size: 1.05em;
      box-shadow: 0 2px 14px #2ecc7144;
    }
    #tipBox label {
      color: #2ecc71;
      font-weight: bold;
      font-size: 1.11em;
      margin-bottom: 5px;
    }
    #cashTag {
      font-size: 1.19em;
      color: #222;
      font-weight: bold;
      background: #e8ffe8;
      border-radius: 9px;
      padding: 4px 10px;
      margin-bottom: 7px;
    }
    #shareLink {
      font-size: 0.97em;
      color: #888;
      margin-top: 6px;
      margin-bottom: 8px;
      word-break: break-all;
    }
    #roomId {
      font-family: monospace;
      color: #2ecc71;
      font-weight: bold;
      letter-spacing: 2px;
      font-size: 1.12em;
      background: #fff;
      border-radius: 8px;
      padding: 3px 12px;
      margin-left: 7px;
    }
    #chatBar {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 0 0 20px 0;
      background: linear-gradient(to top, #f3f3f3 92%, #ffffff00 100%);
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #messages {
      width: 100%;
      max-width: 600px;
      height: 90px;
      overflow-y: auto;
      border-radius: 10px 10px 0 0;
      background: #fff;
      padding: 10px 14px 4px 14px;
      box-shadow: 0 1px 8px #2ecc710c;
      font-size: 1em;
      margin-bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
    }
    .msg {
      margin-bottom: 6px;
      word-break: break-word;
      color: #333;
    }
    .me {
      color: #2ecc71;
      font-weight: bold;
    }
    #inputBar {
      width: 100%;
      max-width: 600px;
      display: flex;
      background: #fff;
      border-radius: 0 0 14px 14px;
      box-shadow: 0 4px 16px #2ecc7109;
      padding: 6px 8px;
      border-top: 1px solid #eee;
      gap: 8px;
    }
    #msgInput {
      flex: 1;
      font-size: 1.05em;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      outline: none;
      background: #f7f7f7;
    }
    #sendBtn {
      font-size: 1.04em;
      padding: 9px 18px;
      border-radius: 8px;
      border: none;
      background: #2ecc71;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
    }
    #sendBtn:hover { background: #1e9f4d; }
    #newRoomBtn {
      margin-left: 18px;
      font-size: 1em;
      background: #2ecc71;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 7px 14px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 1px 7px #2ecc710c;
    }
    #newRoomBtn:hover { background: #1e9f4d; }

    /* Fullscreen QR overlay */
    #qrOverlay {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(243,243,243,0.97);
      align-items: center;
      justify-content: center;
      flex-direction: column;
      animation: fadeIn 0.17s;
    }
    #qrOverlay.visible { display: flex; }
    #qrOverlayContent {
      display: flex;
      align-items: center;
      gap: 36px;
      flex-wrap: wrap;
    }
    #qrOverlay .largeQR {
      background: #fff;
      border-radius: 28px;
      box-shadow: 0 6px 40px #2ecc7130;
      padding: 36px;
      min-width: 320px;
      min-height: 320px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #qrOverlay .closeBtn {
      position: absolute;
      top: 28px;
      right: 38px;
      font-size: 2.1em;
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      z-index: 10000;
      transition: color 0.17s;
    }
    #qrOverlay .closeBtn:hover { color: #2ecc71; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    @media (max-width: 900px) {
      #qrRow, #qrOverlayContent { flex-direction: column; gap: 18px; }
      #qr, #qrOverlay .largeQR { min-width: 0; min-height: 0; }
      #tipBox { min-width: 160px; }
    }
  </style>
</head>
<body>
  <div id="main">
    <div id="topInfo">
      <div class="roomTitle">
        Room: <span id="roomId"></span>
        <button id="newRoomBtn" title="Start a new chat room">New Room</button>
      </div>
      <div id="qrRow">
        <div id="qr" title="Tap to enlarge QR"></div>
        <div id="tipBox">
          <label>Tip the creator ðŸ’š</label>
          <div id="cashTag">$YOURCASHAPP</div>
          <span style="font-size:0.97em;color:#888;">Thank you for supporting!</span>
        </div>
      </div>
      <div id="shareLink"></div>
    </div>
    <div id="chatBar">
      <div id="messages"></div>
      <div id="inputBar">
        <input type="text" id="msgInput" placeholder="Type message..." autocomplete="off">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- QR ENLARGE OVERLAY -->
  <div id="qrOverlay">
    <button class="closeBtn" aria-label="Close">&times;</button>
    <div id="qrOverlayContent">
      <div class="largeQR" id="largeQR"></div>
      <div id="largeTipBox">
        <label style="color:#2ecc71;font-weight:bold;font-size:1.11em;margin-bottom:5px;">Tip the creator ðŸ’š</label>
        <div style="font-size:1.19em;color:#222;font-weight:bold;background:#e8ffe8;border-radius:9px;padding:4px 10px;margin-bottom:7px;">
          $YOURCASHAPP
        </div>
        <span style="font-size:0.97em;color:#888;">Thank you for supporting!</span>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- QR Code JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    // 1. ðŸ”‘ FILL IN YOUR FIREBASE CONFIG HERE:
    var firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com/",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    // 2. Generate long, cryptographically random room codes
    function randomRoom() {
      let arr = new Uint32Array(6);
      window.crypto.getRandomValues(arr);
      return Array.from(arr).map(x => x.toString(36)).join('').toUpperCase();
    }

    function getRoomFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('room');
    }

    function setRoomInUrl(room) {
      window.history.replaceState({}, '', '?room=' + room);
    }

    // 3. Color name pool
    const colorNames = [
      "Green", "Red", "Blue", "Orange", "Purple", "Yellow", "Pink", "Brown",
      "White", "Black", "Cyan", "Magenta", "Teal", "Indigo", "Lime", "Violet"
    ];

    // 4. Assign user a persistent random color name per room (stored in sessionStorage)
    async function assignUserName(room) {
      const key = 'colorName_' + room;
      if (sessionStorage.getItem(key)) return sessionStorage.getItem(key);

      // Get used color names in this room
      const snap = await db.ref('chatrooms/' + room + '/users').once('value');
      const used = new Set();
      snap.forEach(child => used.add(child.val().color));
      // Choose an unused color, or random if all are taken
      let available = colorNames.filter(c => !used.has(c));
      if (available.length === 0) available = colorNames;
      const color = available[Math.floor(Math.random() * available.length)];
      const name = `Mr ${color}`;
      sessionStorage.setItem(key, name);
      // Register in users list
      db.ref('chatrooms/' + room + '/users').push({ color: color, joined: Date.now() });
      return name;
    }

    // 5. State
    let room = getRoomFromUrl() || randomRoom();
    setRoomInUrl(room);
    document.getElementById('roomId').textContent = room;

    // 6. Assign user name
    let myName = null;
    assignUserName(room).then(name => { myName = name; });

    // 7. Display QR and link (as before)
    let joinUrl = window.location.origin + window.location.pathname + '?room=' + room;
    function updateQRandLink() {
      document.getElementById('qr').innerHTML = "";
      joinUrl = window.location.origin + window.location.pathname + '?room=' + room;
      new QRCode(document.getElementById('qr'), {
        text: joinUrl,
        width: 220,
        height: 220
      });
      document.getElementById('shareLink').textContent = "Share this link: " + joinUrl;
    }
    updateQRandLink();

    // 8. Enlarge QR on click
    document.getElementById('qr').addEventListener('click', function() {
      // Show overlay
      document.getElementById('qrOverlay').classList.add('visible');
      // Generate big QR
      document.getElementById('largeQR').innerHTML = "";
      new QRCode(document.getElementById('largeQR'), {
        text: joinUrl,
        width: 350,
        height: 350
      });
    });
    // Close overlay on X or click outside
    document.querySelector('#qrOverlay .closeBtn').onclick = function() {
      document.getElementById('qrOverlay').classList.remove('visible');
      document.getElementById('largeQR').innerHTML = "";
    };
    // Also close if clicking outside content (mobile)
    document.getElementById('qrOverlay').addEventListener('click', function(e) {
      if (e.target === this) {
        document.getElementById('qrOverlay').classList.remove('visible');
        document.getElementById('largeQR').innerHTML = "";
      }
    });

    // 9. Listen for new messages
    const messagesDiv = document.getElementById('messages');
    function addMsg(text, sender) {
      const div = document.createElement('div');
      div.className = 'msg';
      if (sender === myName) {
        div.innerHTML = `<span class="me">${sender}:</span> ${text}`;
      } else {
        div.textContent = (sender ? (sender + ': ') : '') + text;
      }
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    let msgListenerRef = db.ref('chatrooms/' + room + '/messages');
    msgListenerRef.on('child_added', snap => {
      const msg = snap.val();
      addMsg(msg.text, msg.sender);
    });

    // 10. Send new message
    const msgInput = document.getElementById('msgInput');
    function sendMsg() {
      const text = msgInput.value.trim();
      if (!text || !myName) return;
      db.ref('chatrooms/' + room + '/messages').push({
        text: text,
        sender: myName
      });
      msgInput.value = '';
    }
    document.getElementById('sendBtn').onclick = sendMsg;
    msgInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') sendMsg();
    });

    // 11. New room button
    document.getElementById('newRoomBtn').onclick = function() {
      // Remove old listener
      msgListenerRef.off();
      // Remove user color from session for old room:
      sessionStorage.removeItem('colorName_' + room);
      room = randomRoom();
      setRoomInUrl(room);
      document.getElementById('roomId').textContent = room;
      messagesDiv.innerHTML = "";
      updateQRandLink();
      // Set up new listener
      msgListenerRef = db.ref('chatrooms/' + room + '/messages');
      msgListenerRef.on('child_added', snap => {
        const msg = snap.val();
        addMsg(msg.text, msg.sender);
      });
      // Assign new color name for new room
      assignUserName(room).then(name => { myName = name; });
    };

    // 12. Insert your Cash App tag
    document.getElementById('cashTag').textContent = '$YOURCASHAPP';
    document.querySelector('#largeTipBox div').textContent = '$YOURCASHAPP';
  </script>
</body>
</html>
